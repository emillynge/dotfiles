var OAuth2=function(d,a,c){this.adapterName=d;var b=this;OAuth2.loadAdapter(d,function(){b.adapter=OAuth2.adapters[d];if(a==OAuth2.FINISH){b.finishAuth()}else{if(a){b.updateLocalStorage();var e=b.get();e.clientId=a.client_id;e.clientSecret=a.client_secret;e.apiScope=a.api_scope;b.setSource(e)}}if(c){c()}})};OAuth2.FINISH="finish";OAuth2.adapters={};OAuth2.adapterReverse=localStorage.oauth2_adapterReverse&&JSON.parse(localStorage.oauth2_adapterReverse)||{};if(localStorage.adapterReverse){OAuth2.adapterReverse=JSON.parse(localStorage.adapterReverse);delete localStorage.adapterReverse}OAuth2.prototype.updateLocalStorage=function(){if(this.getSource()){return}var c={};var d=["accessToken","accessTokenDate","apiScope","clientId","clientSecret","expiresIn","refreshToken"];var b;for(var a=0;a<d.length;a++){b=this.adapterName+"_"+d[a];if(localStorage.hasOwnProperty(b)){c[d[a]]=localStorage[b];delete localStorage[b]}}this.setSource(c)};OAuth2.prototype.openAuthorizationCodePopup=function(a){window["oauth-callback"]=a;chrome.tabs.create({url:this.adapter.authorizationCodeURL(this.getConfig())},function(b){})};OAuth2.prototype.getAccessAndRefreshTokens=function(j,h){var e=this;var i=new XMLHttpRequest();i.addEventListener("readystatechange",function(k){if(i.readyState==4){if(i.status==200){h(e.adapter.parseAccessToken(i.responseText))}}});var a=e.adapter.accessTokenMethod();var f=e.adapter.accessTokenParams(j,e.getConfig());var g=null;if(a=="POST"){var c=new FormData();for(g in f){c.append(g,f[g])}i.open(a,e.adapter.accessTokenURL(),true);i.send(c)}else{if(a=="GET"){var b=e.adapter.accessTokenURL();var d="?";for(g in f){d+=encodeURIComponent(g)+"="+encodeURIComponent(f[g])+"&"}i.open(a,b+d,true);i.send()}else{throw a+" is an unknown method"}}};OAuth2.prototype.refreshAccessToken=function(a,e){var d=new XMLHttpRequest();d.onreadystatechange=function(f){if(d.readyState==4){if(d.status==200){console.log(d.responseText);var g=JSON.parse(d.responseText);e(g.access_token,g.expires_in)}}};var b=this.get();var c=new FormData();c.append("client_id",b.clientId);c.append("client_secret",b.clientSecret);c.append("refresh_token",a);c.append("grant_type","refresh_token");d.open("POST",this.adapter.accessTokenURL(),true);d.send(c)};OAuth2.prototype.finishAuth=function(){var a=null;var b=this;function d(g){var f=chrome.extension.getViews();for(var h=0,e;e=f[h];h++){if(e["oauth-callback"]){e["oauth-callback"](g)}}window.open("","_self","");window.close()}try{a=b.adapter.parseAuthorizationCode(window.location.href);console.log(a)}catch(c){console.error(c);d(c)}b.getAccessAndRefreshTokens(a,function(e){var g=b.get();g.accessTokenDate=new Date().valueOf();for(var f in e){if(e.hasOwnProperty(f)&&e[f]){g[f]=e[f]}}b.setSource(g);d()})};OAuth2.prototype.isAccessTokenExpired=function(){var a=this.get();return(new Date().valueOf()-a.accessTokenDate)>a.expiresIn*1000};OAuth2.prototype.get=function(a){var c=this.getSource();var b=c?JSON.parse(c):{};return a?b[a]:b};OAuth2.prototype.set=function(a,b){var c=this.get();c[a]=b;this.setSource(c)};OAuth2.prototype.clear=function(a){if(a){var b=this.get();delete b[a];this.setSource(b)}else{delete localStorage["oauth2_"+this.adapterName]}};OAuth2.prototype.getSource=function(){return localStorage["oauth2_"+this.adapterName]};OAuth2.prototype.setSource=function(a){if(!a){return}if(typeof a!=="string"){a=JSON.stringify(a)}localStorage["oauth2_"+this.adapterName]=a};OAuth2.prototype.getConfig=function(){var a=this.get();return{clientId:a.clientId,clientSecret:a.clientSecret,apiScope:a.apiScope}};OAuth2.loadAdapter=function(d,c){if(OAuth2.adapters[d]){c();return}var b=document.querySelector("head");var a=document.createElement("script");a.type="text/javascript";a.src="/oauth2/adapters/"+d+".js";a.addEventListener("load",function(){c()});b.appendChild(a)};OAuth2.adapter=function(c,b){var a="authorizationCodeURL redirectURL accessTokenURL accessTokenMethod accessTokenParams accessToken";a.split(" ").forEach(function(e,d){if(!e in b){throw"Invalid adapter! Missing method: "+e}});OAuth2.adapters[c]=b;OAuth2.adapterReverse[b.redirectURL()]=c;localStorage.oauth2_adapterReverse=JSON.stringify(OAuth2.adapterReverse)};OAuth2.lookupAdapterName=function(a){var b=JSON.parse(localStorage.oauth2_adapterReverse);return b[a]};OAuth2.prototype.authorize=function(b){var a=this;OAuth2.loadAdapter(a.adapterName,function(){a.adapter=OAuth2.adapters[a.adapterName];var c=a.get();if(!c.accessToken){a.openAuthorizationCodePopup(b)}else{if(a.isAccessTokenExpired()){if(c.refreshToken){a.refreshAccessToken(c.refreshToken,function(d,f){var e=a.get();e.accessTokenDate=new Date().valueOf();e.accessToken=d;e.expiresIn=f;a.setSource(e);if(b){b()}})}else{a.openAuthorizationCodePopup(b)}}else{if(b){b()}}}})};OAuth2.prototype.getAccessToken=function(){return this.get("accessToken")};OAuth2.prototype.hasAccessToken=function(){return !!this.get("accessToken")};OAuth2.prototype.clearAccessToken=function(){this.clear("accessToken")};